import{s as k,a as p,b as M,c as H,d as J}from"./index-BBUP-t29.js";import{d as K,i as Q,u as W,r as g,a as Y,o as V,b as Z,c as u,e as d,w as o,f as r,g as i,h as c,j as l,k as v,t as y,s as F}from"./index-DAS6CEhR.js";import{c as L,s as $}from"./utils-D4CJa5ov.js";const ee={style:{display:"flex","justify-content":"end",gap:"0.5rem"}},ne=K({__name:"AddTaskForm",setup(te){const _=Q("dialogRef"),B=W(),b=g([]),w=g([]),I=Y(),R=new Intl.DateTimeFormat("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1});V(async()=>{const s=await L("user.get",{filter:{ACTIVE:!0},select:["LAST_NAME","ID","NAME"]});let e="";for(let t=0;t<s.length;t++)e=s[t].NAME[0]?s[t].NAME[0]+".":"",s[t].fullName=`${e} ${s[t].LAST_NAME}`;b.value=s}),V(async()=>{const e=(await L("tasks.task.getFields",{})).fields.STATUS.values;for(const t in e)w.value.push({desc:e[t],value:t})});const T=[];for(let s=1;s<=31;s++)T.push({value:s});const S=g([{desc:"Понедельник",value:1},{desc:"Вторник",value:2},{desc:"Среда",value:3},{desc:"Четверг",value:4},{desc:"Пятница",value:5},{desc:"Суббота",value:6},{desc:"Воскресенье",value:0}]),N=g([{value:1,desc:"Январь"},{value:2,desc:"Ферваль"},{value:3,desc:"Март"},{value:4,desc:"Апрель"},{value:5,desc:"Май"},{value:6,desc:"Июнь"},{value:7,desc:"Июль"},{value:8,desc:"Август"},{value:9,desc:"Сентябрь"},{value:10,desc:"Октябрь"},{value:11,desc:"Ноябрь"},{value:12,desc:"Декабрь"}]),D=g(T),O=Z({users:[],statusesToUpdate:[],weekDays:[],months:[],monthDays:[],time:new Date}),P=({values:s})=>{const e={};return s.users.length===0&&(e.users=[{message:"Требуется выбрать хотя бы одного пользователя"}]),s.statusesToUpdate.length===0&&(e.statusesToUpdate=[{message:"Требуется выбрать хотя бы один статус"}]),s.newStatus||(e.newStatus=[{message:"Выберите валидный статус задачи"}]),s.weekDays.length===0&&(e.weekDays=[{message:"Требуется хотя бы один день недели"}]),s.months.length===0&&(e.months=[{message:"Требуется хотя бы один день недели"}]),s.monthDays.length===0?e.monthDays=[{message:"Требуется хотя бы один день месяца"}]:s.monthDays.length>5&&s.monthDays.length!==D.value.length&&(e.monthDays=[{message:"Требуется не больше 5 выбранных значений"}]),isNaN(Date.parse(s.time))&&(e.time=[{message:"Время не соответствует требуемому формату"}]),{values:s,errors:e}},A=g(!1),X=async({valid:s,values:e,...t})=>{if(t.originalEvent.preventDefault(),s){const n=new FormData;n.set("users",e.users.join(",")),n.set("statuses_to_update",e.statusesToUpdate.join(",")),n.set("new_status",e.newStatus),e.weekDays.length===S.value.length?n.set("week_days","*"):n.set("week_days",e.weekDays.join(",")),e.monthDays.length===D.value.length?n.set("month_days","*"):n.set("month_days",e.monthDays.join(",")),e.months.length===N.value.length?n.set("months","*"):n.set("months",e.months.join(","));const f=R.format(new Date(e.time)).split(":");n.set("time_hour",f[0]),n.set("time_min",f[1]);const h=BX24.getAuth();n.set("member_id",h.member_id),n.set("access_token",h.access_token),n.set("refresh_token",h.refresh_token),await q(n)}};async function q(s){try{await fetch("https://bg59.online/Apps/tasks_market_dev/api/tasks/add.php",{method:"POST",body:s}).then(e=>{if(!e.ok)throw new Error("Не удалось добавить задачу")}),_.value.close(),I.replace({name:"tasks",force:!0})}catch(e){e instanceof Error&&B.add({summary:"Ошибка действия",detail:"Произошла ошибка при добавлении новой задачи",severity:"error",life:6e3})}}return(s,e)=>(d(),u(l(J),{initialValues:O,resolver:P,onSubmit:X,style:{display:"flex",gap:"1rem","flex-direction":"column"}},{default:o(t=>{var n,f,h,U,x,E,j,C,z;return[r("div",null,[i(l(k),{name:"users",filter:"",options:b.value,"option-label":"fullName",placeholder:"Пользователи","option-value":"ID",maxSelectedLabels:4,"selected-items-label":`Выбрано ${((n=t.users)==null?void 0:n.value.length)??0} пользователей`,fluid:"","empty-filter-message":"Нечего не найдено"},null,8,["options","selected-items-label"]),(f=t.users)!=null&&f.invalid?(d(),u(l(p),{key:0,severity:"error",size:"small",variant:"simple",style:{"margin-top":"0.5rem"}},{default:o(()=>{var a;return[v(y((a=t.users.error)==null?void 0:a.message),1)]}),_:2},1024)):c("",!0)]),r("div",null,[i(l(M),{variant:"on"},{default:o(()=>[i(l($),{style:{"min-width":"15rem"},name:"newStatus",options:w.value,"option-label":"desc","empty-filter-message":"Нечего не найдено","input-id":"new-status","option-value":"value",onChange:a=>{const m=t.statusesToUpdate.value.findIndex(G=>G===a.value);t.statusesToUpdate.value.splice(m,1)}},null,8,["options","onChange"]),e[1]||(e[1]=r("label",{for:"new-status"},"Новый статус",-1))]),_:2},1024),(h=t.newStatus)!=null&&h.invalid?(d(),u(l(p),{key:0,severity:"error",size:"small",variant:"simple",style:{"margin-top":"0.5rem"}},{default:o(()=>[v(y(t.newStatus.error.message),1)]),_:2},1024)):c("",!0)]),r("div",null,[i(l(k),{name:"statusesToUpdate",filter:"",options:w.value.filter(a=>{var m;return a.value!==((m=t.newStatus)==null?void 0:m.value)}),"option-label":"desc","option-value":"value",placeholder:"Статусы для обновления",maxSelectedLabels:5,"selected-items-label":`Выбрано ${((U=t.statusesToUpdate)==null?void 0:U.value.length)??0} статусов`,"empty-filter-message":"Нечего не найдено",fluid:""},null,8,["options","selected-items-label"]),(x=t.statusesToUpdate)!=null&&x.invalid?(d(),u(l(p),{key:0,severity:"error",size:"small",variant:"simple",style:{"margin-top":"0.5rem"}},{default:o(()=>{var a;return[v(y((a=t.statusesToUpdate.error)==null?void 0:a.message),1)]}),_:2},1024)):c("",!0)]),r("div",null,[i(l(k),{name:"weekDays",filter:"",options:S.value,"option-label":"desc","option-value":"value",placeholder:"Дни недели","empty-filter-message":"Нечего не найдено",fluid:""},null,8,["options"]),(E=t.weekDays)!=null&&E.invalid?(d(),u(l(p),{key:0,severity:"error",size:"small",variant:"simple",style:{"margin-top":"0.5rem"}},{default:o(()=>{var a;return[v(y((a=t.weekDays.error)==null?void 0:a.message),1)]}),_:2},1024)):c("",!0)]),r("div",null,[i(l(k),{name:"months",filter:"",options:N.value,"option-label":"desc",placeholder:"Месяцы","empty-filter-message":"Нечего не найдено","option-value":"value",fluid:""},null,8,["options"]),(j=t.months)!=null&&j.invalid?(d(),u(l(p),{key:0,severity:"error",size:"small",variant:"simple",style:{"margin-top":"0.5rem"}},{default:o(()=>{var a;return[v(y((a=t.months.error)==null?void 0:a.message),1)]}),_:2},1024)):c("",!0)]),r("div",null,[i(l(k),{name:"monthDays",filter:"",options:D.value,"option-label":"value",placeholder:"Дни месяца","option-value":"value","empty-filter-message":"Нечего не найдено",fluid:""},null,8,["options"]),(C=t.monthDays)!=null&&C.invalid?(d(),u(l(p),{key:0,severity:"error",size:"small",variant:"simple",style:{"margin-top":"0.5rem"}},{default:o(()=>{var a;return[v(y((a=t.monthDays.error)==null?void 0:a.message),1)]}),_:2},1024)):c("",!0)]),r("div",null,[i(l(M),{variant:"on"},{default:o(()=>[i(l(H),{name:"time","input-id":"time","time-only":""}),e[2]||(e[2]=r("label",{for:"time"},"Время (МСК)",-1))]),_:1}),(z=t.time)!=null&&z.invalid?(d(),u(l(p),{key:0,severity:"error",size:"small",variant:"simple",style:{"margin-top":"0.5rem"}},{default:o(()=>{var a;return[v(y((a=t.time.error)==null?void 0:a.message),1)]}),_:2},1024)):c("",!0)]),r("div",ee,[i(l(F),{type:"button",label:"Отменить",severity:"secondary",loading:A.value,onClick:e[0]||(e[0]=a=>{var m;return(m=l(_))==null?void 0:m.close()})},null,8,["loading"]),i(l(F),{type:"submit",label:"Сохранить",loading:A.value},null,8,["loading"])])]}),_:1},8,["initialValues"]))}});export{ne as default};
