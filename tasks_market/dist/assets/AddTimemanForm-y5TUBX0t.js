import{s as g,a as c,b as M,c as P,d as U}from"./index-BBUP-t29.js";import{d as X,i as q,u as G,r as f,a as H,o as J,b as K,c as m,e as u,w as o,f as r,g as i,h as p,j as a,k as y,t as v,s as V}from"./index-DAS6CEhR.js";import{c as Q,s as W}from"./utils-D4CJa5ov.js";const Y={style:{display:"flex","justify-content":"end",gap:"0.5rem"}},se=X({__name:"AddTimemanForm",setup(Z){const w=q("dialogRef"),z=G(),_=f([]),C=[{value:"1",desc:"Начать"},{value:"2",desc:"Продолжить"},{value:"3",desc:"Перерыв"},{value:"4",desc:"Завершить"}],B=H(),F=new Intl.DateTimeFormat("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1});J(async()=>{const t=await Q("user.get",{filter:{ACTIVE:!0},select:["LAST_NAME","ID","NAME"]});let e="";for(let s=0;s<t.length;s++)e=t[s].NAME[0]?t[s].NAME[0]+".":"",t[s].fullName=`${e} ${t[s].LAST_NAME}`;_.value=t});const k=[];for(let t=1;t<=31;t++)k.push({value:t});const b=f([{desc:"Понедельник",value:1},{desc:"Вторник",value:2},{desc:"Среда",value:3},{desc:"Четверг",value:4},{desc:"Пятница",value:5},{desc:"Суббота",value:6},{desc:"Воскресенье",value:0}]),S=f([{value:1,desc:"Январь"},{value:2,desc:"Ферваль"},{value:3,desc:"Март"},{value:4,desc:"Апрель"},{value:5,desc:"Май"},{value:6,desc:"Июнь"},{value:7,desc:"Июль"},{value:8,desc:"Август"},{value:9,desc:"Сентябрь"},{value:10,desc:"Октябрь"},{value:11,desc:"Ноябрь"},{value:12,desc:"Декабрь"}]),D=f(k),L=K({users:[],weekDays:[],months:[],monthDays:[],time:new Date}),I=({values:t})=>{const e={};return t.users.length===0&&(e.users=[{message:"Требуется выбрать хотя бы одного пользователя"}]),t.newStatus||(e.newStatus=[{message:"Выберите валидный статус задачи"}]),t.weekDays.length===0&&(e.weekDays=[{message:"Требуется хотя бы один день недели"}]),t.months.length===0&&(e.months=[{message:"Требуется хотя бы один день недели"}]),t.monthDays.length===0?e.monthDays=[{message:"Требуется хотя бы один день месяца"}]:t.monthDays.length>5&&t.monthDays.length!==D.value.length&&(e.monthDays=[{message:"Требуется не больше 5 выбранных значений"}]),isNaN(Date.parse(t.time))&&(e.time=[{message:"Время не соответствует требуемому формату"}]),{values:t,errors:e}},N=f(!1),R=async({valid:t,values:e,...s})=>{if(s.originalEvent.preventDefault(),t){const l=new FormData;l.set("users",e.users.join(",")),l.set("new_status",e.newStatus),e.weekDays.length===b.value.length?l.set("week_days","*"):l.set("week_days",e.weekDays.join(",")),e.monthDays.length===D.value.length?l.set("month_days","*"):l.set("month_days",e.monthDays.join(",")),e.months.length===S.value.length?l.set("months","*"):l.set("months",e.months.join(","));const h=F.format(new Date(e.time)).split(":");l.set("time_hour",h[0]),l.set("time_min",h[1]);const d=BX24.getAuth();l.set("member_id",d.member_id),l.set("access_token",d.access_token),l.set("refresh_token",d.refresh_token),await O(l)}};async function O(t){try{await fetch("https://bg59.online/Apps/tasks_market_dev/api/timeman/add.php",{method:"POST",body:t}).then(e=>{if(!e.ok)throw new Error("Не удалось добавить задачу")}),w.value.close(),B.replace({name:"timeman",force:!0})}catch(e){e instanceof Error&&z.add({summary:"Ошибка действия",detail:"Произошла ошибка при добавлении новой задачи",severity:"error",life:6e3})}}return(t,e)=>(u(),m(a(U),{initialValues:L,resolver:I,onSubmit:R,style:{display:"flex",gap:"1rem","flex-direction":"column"}},{default:o(s=>{var l,h,d,A,E,x,T;return[r("div",null,[i(a(g),{name:"users",filter:"",options:_.value,"option-label":"fullName",placeholder:"Пользователи","option-value":"ID",maxSelectedLabels:4,"selected-items-label":`Выбрано ${((l=s.users)==null?void 0:l.value.length)??0} пользователей`,fluid:"","empty-filter-message":"Нечего не найдено"},null,8,["options","selected-items-label"]),(h=s.users)!=null&&h.invalid?(u(),m(a(c),{key:0,severity:"error",size:"small",variant:"simple",style:{"margin-top":"0.5rem"}},{default:o(()=>{var n;return[y(v((n=s.users.error)==null?void 0:n.message),1)]}),_:2},1024)):p("",!0)]),r("div",null,[i(a(M),{variant:"on"},{default:o(()=>[i(a(W),{style:{"min-width":"15rem"},name:"newStatus",options:C,"option-label":"desc","empty-filter-message":"Нечего не найдено","input-id":"new-status","option-value":"value"}),e[1]||(e[1]=r("label",{for:"new-status"},"Статус работника",-1))]),_:1}),(d=s.newStatus)!=null&&d.invalid?(u(),m(a(c),{key:0,severity:"error",size:"small",variant:"simple",style:{"margin-top":"0.5rem"}},{default:o(()=>[y(v(s.newStatus.error.message),1)]),_:2},1024)):p("",!0)]),r("div",null,[i(a(g),{name:"weekDays",filter:"",options:b.value,"option-label":"desc","option-value":"value",placeholder:"Дни недели","empty-filter-message":"Нечего не найдено",fluid:""},null,8,["options"]),(A=s.weekDays)!=null&&A.invalid?(u(),m(a(c),{key:0,severity:"error",size:"small",variant:"simple",style:{"margin-top":"0.5rem"}},{default:o(()=>{var n;return[y(v((n=s.weekDays.error)==null?void 0:n.message),1)]}),_:2},1024)):p("",!0)]),r("div",null,[i(a(g),{name:"months",filter:"",options:S.value,"option-label":"desc",placeholder:"Месяцы","empty-filter-message":"Нечего не найдено","option-value":"value",fluid:""},null,8,["options"]),(E=s.months)!=null&&E.invalid?(u(),m(a(c),{key:0,severity:"error",size:"small",variant:"simple",style:{"margin-top":"0.5rem"}},{default:o(()=>{var n;return[y(v((n=s.months.error)==null?void 0:n.message),1)]}),_:2},1024)):p("",!0)]),r("div",null,[i(a(g),{name:"monthDays",filter:"",options:D.value,"option-label":"value",placeholder:"Дни месяца","option-value":"value","empty-filter-message":"Нечего не найдено",fluid:""},null,8,["options"]),(x=s.monthDays)!=null&&x.invalid?(u(),m(a(c),{key:0,severity:"error",size:"small",variant:"simple",style:{"margin-top":"0.5rem"}},{default:o(()=>{var n;return[y(v((n=s.monthDays.error)==null?void 0:n.message),1)]}),_:2},1024)):p("",!0)]),r("div",null,[i(a(M),{variant:"on"},{default:o(()=>[i(a(P),{name:"time","input-id":"time","time-only":""}),e[2]||(e[2]=r("label",{for:"time"},"Время (МСК)",-1))]),_:1}),(T=s.time)!=null&&T.invalid?(u(),m(a(c),{key:0,severity:"error",size:"small",variant:"simple",style:{"margin-top":"0.5rem"}},{default:o(()=>{var n;return[y(v((n=s.time.error)==null?void 0:n.message),1)]}),_:2},1024)):p("",!0)]),r("div",Y,[i(a(V),{type:"button",label:"Отменить",severity:"secondary",loading:N.value,onClick:e[0]||(e[0]=n=>{var j;return(j=a(w))==null?void 0:j.close()})},null,8,["loading"]),i(a(V),{type:"submit",label:"Сохранить",loading:N.value},null,8,["loading"])])]}),_:1},8,["initialValues"]))}});export{se as default};
