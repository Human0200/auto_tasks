import{d as $,u as j,r as E,b as B,aj as R,o as q,m as n,f as T,g as c,w as y,j as l,S as f,U as v,c as A,s as w,am as z,e as r,t as k}from"./index-DAS6CEhR.js";import{s as V,a as h}from"./index-Cland8-X.js";import{c as D}from"./utils-D4CJa5ov.js";const O={key:0},W={key:1},F={style:{"overflow-y":"auto","max-height":"5rem"}},G={style:{margin:"0"}},H={style:{margin:"0"}},X={key:0,style:{"overflow-y":"auto","max-height":"5rem"}},J={key:1},K={key:0,style:{margin:"0"}},Q={key:1},Y={key:0,style:{"overflow-y":"auto","max-height":"5rem"}},Z={key:1},se=$({__name:"TasksView",setup(P){const p=j(),_=E(!1),i=E([]),u=B(new Set),L=z(),x=[{desc:"Понедельник",value:1},{desc:"Вторник",value:2},{desc:"Среда",value:3},{desc:"Четверг",value:4},{desc:"Пятница",value:5},{desc:"Суббота",value:6},{desc:"Воскресенье",value:0}],M=[{value:1,desc:"Январь"},{value:2,desc:"Ферваль"},{value:3,desc:"Март"},{value:4,desc:"Апрель"},{value:5,desc:"Май"},{value:6,desc:"Июнь"},{value:7,desc:"Июль"},{value:8,desc:"Август"},{value:9,desc:"Сентябрь"},{value:10,desc:"Октябрь"},{value:11,desc:"Ноябрь"},{value:12,desc:"Декабрь"}];R(()=>L.path,async()=>b(),{deep:!0}),q(async()=>b());async function b(){try{_.value=!0;const a=BX24.getAuth().member_id;i.value=await U(a);const o=await D("user.get",{filter:{ACTIVE:!0},select:["LAST_NAME","ID","NAME"]}),e=await D("tasks.task.getFields",{}),t=[],d=e.fields.STATUS.values;for(const s in d)t.push({desc:d[s],value:s});let S="";for(let s=0;s<o.length;s++)S=o[s].NAME[0]?o[s].NAME[0]+".":"",o[s].fullName=`${S} ${o[s].LAST_NAME}`;for(let s=0;s<i.value.length;s++)i.value[s].Users=i.value[s].Users.split(",").map(m=>o.find(g=>g.ID===m).fullName),i.value[s].NewStatus=t.find(m=>m.value===i.value[s].NewStatus).desc,i.value[s].StatusesToUpdate=i.value[s].StatusesToUpdate.split(",").map(m=>t.find(g=>g.value===m).desc),i.value[s].Time=`${i.value[s].Hours}:${i.value[s].Minutes}`}catch(a){p.add({summary:"Ошибка действия",detail:"Произошла ошибка при получении задач",severity:"error",life:6e3}),console.error(a)}finally{_.value=!1}}async function U(a){const o=new URLSearchParams({memberId:a});try{return await fetch("https://bg59.online/Apps/tasks_market_dev/api/tasks/list.php?"+o.toString(),{method:"GET",headers:{Accept:"application/json"}}).then(t=>{if(!t.ok)throw new Error("Неудалось получить задачи");return t.json()})}catch(e){return e instanceof Error&&p.add({summary:"Ошибка действия",detail:"Произошла ошибка при получении задач",severity:"error",life:6e3}),[]}}async function I(a){u.add(a);const o=new URLSearchParams({elid:a});try{await fetch("https://bg59.online/Apps/tasks_market_dev/api/tasks/suspend.php?"+o.toString(),{method:"POST",headers:{Accept:"application/json"}}).then(e=>{if(!e.ok)throw new Error("Не удалось остановить задачу");i.value.find(t=>t.ELID===a).Active=!1})}catch(e){e instanceof Error&&p.add({summary:"Ошибка действия",detail:"Произошла ошибка при остановке задачи",severity:"error",life:6e3})}u.delete(a)}async function N(a){u.add(a);const o=new URLSearchParams({elid:a});try{await fetch("https://bg59.online/Apps/tasks_market_dev/api/tasks/resume.php?"+o.toString(),{method:"POST",headers:{Accept:"application/json"}}).then(e=>{if(!e.ok)throw new Error("Не удалось возобновить задачу");i.value.find(t=>t.ELID===a).Active=!0})}catch(e){e instanceof Error&&p.add({summary:"Ошибка действия",detail:"Произошла ошибка при возобновить задачу",severity:"error",life:6e3})}u.delete(a)}async function C(a){u.add(a);const o=new URLSearchParams({elid:a});try{await fetch("https://bg59.online/Apps/tasks_market_dev/api/tasks/delete.php?"+o.toString(),{method:"POST",headers:{Accept:"application/json"}}).then(e=>{if(!e.ok)throw new Error("Не удалось удалить задачу");i.value=i.value.filter(t=>t.ELID!==a)})}catch(e){e instanceof Error&&p.add({summary:"Ошибка действия",detail:"Произошла ошибка при удалении задачи",severity:"error",life:6e3})}u.delete(a)}return(a,o)=>_.value?(r(),n("h1",O,"Загрузка...")):(r(),n("main",W,[o[0]||(o[0]=T("h1",null,"Задачи",-1)),c(l(V),{value:i.value,tableStyle:"min-width: 50rem; margin-top: 1rem; font-size: 14px;"},{default:y(()=>[c(l(h),{field:"Users",header:"Пользователи"},{body:y(e=>[T("div",F,[(r(!0),n(f,null,v(e.data.Users,t=>(r(),n("p",G,k(t),1))),256))])]),_:1}),c(l(h),{field:"NewStatus",header:"Новый статус",style:{"max-width":"140px"}}),c(l(h),{field:"StatusesToUpdate",header:"Статусы для изменения",style:{"max-width":"140px"}},{body:y(e=>[(r(!0),n(f,null,v(e.data.StatusesToUpdate,t=>(r(),n("p",H,k(t),1))),256))]),_:1}),c(l(h),{header:"Активная","body-style":"text-align: center"},{body:y(e=>[e.data.Active?(r(),A(l(w),{key:0,type:"button",icon:"pi pi-lightbulb",style:{"font-size":"1rem"},"area-label":"Toggle",severity:"info",loading:u.has(e.data.ELID),raised:"",onClick:t=>I(e.data.ELID)},null,8,["loading","onClick"])):(r(),A(l(w),{key:1,type:"button",icon:"pi pi-lightbulb",style:{"font-size":"1rem"},"area-label":"Toggle",severity:"secondary",loading:u.has(e.data.ELID),raised:"",onClick:t=>N(e.data.ELID)},null,8,["loading","onClick"]))]),_:1}),c(l(h),{field:"Time",header:"Время"}),c(l(h),{field:"WeekDays",header:"Дни недели",style:{"max-width":"200px"}},{body:y(e=>[e.data.WeekDays!=="*"?(r(),n("div",X,[(r(!0),n(f,null,v(e.data.WeekDays.split(",").map(t=>x.find(d=>d.value===+t).desc),(t,d)=>(r(),n("p",{style:{margin:"0"},key:d},k(t),1))),128))])):(r(),n("p",J,"Все дни недели"))]),_:1}),c(l(h),{field:"MonthDays",header:"Дни месяца"},{body:y(e=>[e.data.MonthDays!=="*"?(r(),n("p",K,[(r(!0),n(f,null,v(e.data.MonthDays,(t,d)=>(r(),n("span",{key:d},k(t),1))),128))])):(r(),n("p",Q,"Все дни месяца"))]),_:1}),c(l(h),{field:"Months",header:"Месяцы",style:{"max-width":"140px"}},{body:y(e=>[e.data.Months!=="*"?(r(),n("div",Y,[(r(!0),n(f,null,v(e.data.Months.split(",").map(t=>M.find(d=>d.value===+t).desc),(t,d)=>(r(),n("p",{style:{margin:"0"},key:d},k(t),1))),128))])):(r(),n("p",Z,"Все месяцы"))]),_:1}),c(l(h),null,{body:y(e=>[c(l(w),{type:"button",icon:"pi pi-trash",style:{"font-size":"1rem"},"area-label":"Delete",severity:"danger",loading:u.has(e.data.ELID),onClick:t=>C(e.data.ELID),raised:""},null,8,["loading","onClick"])]),_:1})]),_:1},8,["value"])]))}});export{se as default};
