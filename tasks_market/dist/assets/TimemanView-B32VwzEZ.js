import{d as N,u as C,r as g,b as U,aj as $,o as j,m as n,f as w,g as d,w as h,j as l,S as y,U as p,c as b,s as k,am as B,e as s,t as v}from"./index-DAS6CEhR.js";import{s as R,a as u}from"./index-Cland8-X.js";import{c as q}from"./utils-D4CJa5ov.js";const z={key:0},V={key:1},O={style:{"overflow-y":"auto","max-height":"5rem"}},W={style:{margin:"0"}},F={key:0,style:{"overflow-y":"auto","max-height":"5rem"}},G={key:1},H={key:0,style:{margin:"0"}},X={key:1},J={key:0,style:{"overflow-y":"auto","max-height":"5rem"}},K={key:1},ee=N({__name:"TimemanView",setup(Q){const m=C(),f=g(!1),i=g([]),c=U(new Set),E=B(),A=[{desc:"Понедельник",value:1},{desc:"Вторник",value:2},{desc:"Среда",value:3},{desc:"Четверг",value:4},{desc:"Пятница",value:5},{desc:"Суббота",value:6},{desc:"Воскресенье",value:0}],D=[{value:1,desc:"Январь"},{value:2,desc:"Ферваль"},{value:3,desc:"Март"},{value:4,desc:"Апрель"},{value:5,desc:"Май"},{value:6,desc:"Июнь"},{value:7,desc:"Июль"},{value:8,desc:"Август"},{value:9,desc:"Сентябрь"},{value:10,desc:"Октябрь"},{value:11,desc:"Ноябрь"},{value:12,desc:"Декабрь"}],S=[{value:"1",desc:"Начать"},{value:"2",desc:"Продолжить"},{value:"3",desc:"Перерыв"},{value:"4",desc:"Завершить"}];$(()=>E.path,async()=>_(),{deep:!0}),j(async()=>_());async function _(){try{f.value=!0;const a=BX24.getAuth().member_id;i.value=await L(a);const r=await q("user.get",{filter:{ACTIVE:!0},select:["LAST_NAME","ID","NAME"]});let t="";for(let e=0;e<r.length;e++)t=r[e].NAME[0]?r[e].NAME[0]+".":"",r[e].fullName=`${t} ${r[e].LAST_NAME}`;for(let e=0;e<i.value.length;e++)i.value[e].Users=i.value[e].Users.split(",").map(o=>r.find(I=>I.ID===o).fullName),i.value[e].NewStatus=S.find(o=>o.value===i.value[e].NewStatus).desc,i.value[e].Time=`${i.value[e].Hours}:${i.value[e].Minutes}`}catch(a){m.add({summary:"Ошибка действия",detail:"Произошла ошибка при получении задач",severity:"error",life:6e3}),console.error(a)}finally{f.value=!1}}async function L(a){const r=new URLSearchParams({memberId:a});try{return await fetch("https://bg59.online/Apps/tasks_market_dev/api/timeman/list.php?"+r.toString(),{method:"GET",headers:{Accept:"application/json"}}).then(e=>{if(!e.ok)throw new Error("Неудалось получить задачи");return e.json()})}catch(t){return t instanceof Error&&m.add({summary:"Ошибка действия",detail:"Произошла ошибка при получении задач",severity:"error",life:6e3}),[]}}async function T(a){c.add(a);const r=new URLSearchParams({elid:a});try{await fetch("https://bg59.online/Apps/tasks_market_dev/api/timeman/suspend.php?"+r.toString(),{method:"POST",headers:{Accept:"application/json"}}).then(t=>{if(!t.ok)throw new Error("Не удалось остановить задачу");i.value.find(e=>e.ELID===a).Active=!1})}catch(t){t instanceof Error&&m.add({summary:"Ошибка действия",detail:"Произошла ошибка при остановке задачи",severity:"error",life:6e3})}c.delete(a)}async function x(a){c.add(a);const r=new URLSearchParams({elid:a});try{await fetch("https://bg59.online/Apps/tasks_market_dev/api/timeman/resume.php?"+r.toString(),{method:"POST",headers:{Accept:"application/json"}}).then(t=>{if(!t.ok)throw new Error("Не удалось возобновить задачу");i.value.find(e=>e.ELID===a).Active=!0})}catch(t){t instanceof Error&&m.add({summary:"Ошибка действия",detail:"Произошла ошибка при возобновить задачу",severity:"error",life:6e3})}c.delete(a)}async function M(a){c.add(a);const r=new URLSearchParams({elid:a});try{await fetch("https://bg59.online/Apps/tasks_market_dev/api/timeman/delete.php?"+r.toString(),{method:"POST",headers:{Accept:"application/json"}}).then(t=>{if(!t.ok)throw new Error("Не удалось удалить задачу");i.value=i.value.filter(e=>e.ELID!==a)})}catch(t){t instanceof Error&&m.add({summary:"Ошибка действия",detail:"Произошла ошибка при удалении задачи",severity:"error",life:6e3})}c.delete(a)}return(a,r)=>f.value?(s(),n("h1",z,"Загрузка...")):(s(),n("main",V,[r[0]||(r[0]=w("h1",null,"Учёт рабочего времени",-1)),d(l(R),{value:i.value,tableStyle:"min-width: 50rem; margin-top: 1rem; font-size: 14px;"},{default:h(()=>[d(l(u),{field:"Users",header:"Пользователи"},{body:h(t=>[w("div",O,[(s(!0),n(y,null,p(t.data.Users,e=>(s(),n("p",W,v(e),1))),256))])]),_:1}),d(l(u),{field:"NewStatus",header:"Новый статус работника",style:{"max-width":"140px"}}),d(l(u),{header:"Активная","body-style":"text-align: center"},{body:h(t=>[t.data.Active?(s(),b(l(k),{key:0,type:"button",icon:"pi pi-lightbulb",style:{"font-size":"1rem"},"area-label":"Toggle",severity:"info",loading:c.has(t.data.ELID),raised:"",onClick:e=>T(t.data.ELID)},null,8,["loading","onClick"])):(s(),b(l(k),{key:1,type:"button",icon:"pi pi-lightbulb",style:{"font-size":"1rem"},"area-label":"Toggle",severity:"secondary",loading:c.has(t.data.ELID),raised:"",onClick:e=>x(t.data.ELID)},null,8,["loading","onClick"]))]),_:1}),d(l(u),{field:"Time",header:"Время"}),d(l(u),{field:"WeekDays",header:"Дни недели",style:{"max-width":"200px"}},{body:h(t=>[t.data.WeekDays!=="*"?(s(),n("div",F,[(s(!0),n(y,null,p(t.data.WeekDays.split(",").map(e=>A.find(o=>o.value===+e).desc),(e,o)=>(s(),n("p",{style:{margin:"0"},key:o},v(e),1))),128))])):(s(),n("p",G,"Все дни недели"))]),_:1}),d(l(u),{field:"MonthDays",header:"Дни месяца"},{body:h(t=>[t.data.MonthDays!=="*"?(s(),n("p",H,[(s(!0),n(y,null,p(t.data.MonthDays,(e,o)=>(s(),n("span",{key:o},v(e),1))),128))])):(s(),n("p",X,"Все дни месяца"))]),_:1}),d(l(u),{field:"Months",header:"Месяцы",style:{"max-width":"140px"}},{body:h(t=>[t.data.Months!=="*"?(s(),n("div",J,[(s(!0),n(y,null,p(t.data.Months.split(",").map(e=>D.find(o=>o.value===+e).desc),(e,o)=>(s(),n("p",{style:{margin:"0"},key:o},v(e),1))),128))])):(s(),n("p",K,"Все месяцы"))]),_:1}),d(l(u),null,{body:h(t=>[d(l(k),{type:"button",icon:"pi pi-trash",style:{"font-size":"1rem"},"area-label":"Delete",severity:"danger",loading:c.has(t.data.ELID),onClick:e=>M(t.data.ELID),raised:""},null,8,["loading","onClick"])]),_:1})]),_:1},8,["value"])]))}});export{ee as default};
